---
- name: Run tests on bastion
  hosts: bastion
  tasks:
    - block:
      - name: collect remote test names
        shell: (cd /tmp/poc/tests && ls -d bats_test_bastion*)
        register: test_directories

      - name: run bats tests
        shell: './generic_bats_wrapper.bash {{ item }}'
        args:
          chdir: '/tmp/poc/tests'
        register: test_output
        with_items: "{{ test_directories.stdout_lines }}"
        when:
          - item not in poc_test_blacklist|default([])

      always:
        - name: cleanup test files
          file:
            path: /tmp/poc
            state: absent
          when:
            - test_cleanup|default(true)|bool == true

- name: Run tests on masters
  hosts: masters
  tasks:
    - block:
      - name: collect remote test names
        shell: (cd /tmp/poc/tests && ls -d bats_test_master*)
        register: test_directories

      - name: run bats tests
        shell: './generic_bats_wrapper.bash {{ item }}'
        args:
          chdir: '/tmp/poc/tests'
        register: test_output
        with_items: "{{ test_directories.stdout_lines }}"
        when:
          - item not in poc_test_blacklist|default([])

      - name: collect remote test names
        shell: (cd /tmp/poc/tests && ls -d bats_test_openshift*)
        register: test_directories

      - name: run bats tests from OpenShift project context
        shell: './openshift_bats_wrapper.bash {{ item }}'
        args:
          chdir: '/tmp/poc/tests'
        register: test_output
        with_items: "{{ test_directories.stdout_lines }}"
        when:
          - item not in poc_test_blacklist|default([])

      always:
        - name: cleanup test files
          file:
            path: /tmp/poc
            state: absent
          when:
            - test_cleanup|default(true)|bool == true
