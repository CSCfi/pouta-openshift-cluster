---
image:
  name: docker-registry.rahti.csc.fi/rahti-docker-prod/poc-deployer:v1.0.1

variables:
  DOCKER_DRIVER: overlay
  GITHUB_MIRROR: git@github.com:CSCfi/pouta-openshift-cluster.git

before_script:
  - cp -r $CI_PROJECT_DIR /opt/deployment/poc
  - cd /opt/deployment
  - mkdir -p ~/.ssh
  - eval "$(ssh-agent -s)"
  - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config
  - echo "$CI_RUNNER_SSH_KEY" > ~/.ssh/id_rsa && chmod 0600 ~/.ssh/id_rsa
  - rm -rf openshift-environments
  - git clone $ENVIRONMENTS_REPO_URL openshift-environments
  - '(cd openshift-environments; git rev-parse --verify -q remotes/origin/$CI_COMMIT_REF_NAME) &&
     (cd openshift-environments; git checkout $CI_COMMIT_REF_NAME; git pull)'
  - '(cd openshift-environments; git rev-parse --verify -q remotes/origin/$CI_COMMIT_REF_NAME) ||
     (cd openshift-environments; git checkout master; git pull)'

stages:
  - ci_env_deploy
  - ci_run_tests
  - ci_backups
  - cleanup
  - qa_env_deploy
  - qa_run_tests
  - mirroring
  - prod_deploy
  - scheduled_backups

deploy_ci_openshift_job:
  stage: ci_env_deploy
  variables:
    ENV_NAME: oso-ci-singlemaster
  except:
    - schedules
  script:
    - ./run_playbook.bash site.yml
  environment:
    name: oso-ci

run_ci_tests_openshift_job:
  stage: ci_run_tests
  variables:
    ENV_NAME: oso-ci-singlemaster
  except:
    - schedules
  script:
    - ./run_playbook.bash ../tests/site.yml

backup_ci_openshift_job:
  stage: ci_backups
  variables:
    ENV_NAME: oso-ci-singlemaster
  except:
    - schedules
  script:
    - ./run_backup.bash

deprovision_ci_openshift_job:
  stage: cleanup
  variables:
    ENV_NAME: oso-ci-singlemaster
  except:
    - schedules
  script:
    - ./run_playbook.bash deprovision.yml
  when: always

deploy_qa_openshift_job:
  stage: qa_env_deploy
  variables:
    ENV_NAME: oso-qa
  except:
    - schedules
  script:
    - ./run_playbook.bash site.yml
  environment:
    name: oso-qa
  only:
    - master
  tags:
    - oso-qa

run_qa_tests_openshift_job:
  stage: qa_run_tests
  variables:
    ENV_NAME: oso-qa
  except:
    - schedules
  script:
    - ./run_playbook.bash ../tests/site.yml
  only:
    - master
  tags:
    - oso-qa

mirror_to_github:
  stage: mirroring
  except:
    - schedules
  script:
    - rm -rf poc-bare
    - git clone --bare $CI_REPOSITORY_URL poc-bare
    - cd poc-bare
    - git push --mirror $GITHUB_MIRROR

deploy_rahti_int_job:
  stage: prod_deploy
  variables:
    ENV_NAME: rahti-int
  except:
    - schedules
  script:
    - ./run_backup.bash
    - ./run_playbook.bash site.yml
  environment:
    name: production/rahti-int
  when: manual
  only:
    - master
  tags:
    - rahti-int

deploy_rahti_job:
  stage: prod_deploy
  variables:
    ENV_NAME: rahti
  except:
    - schedules
  script:
    - ./run_backup.bash
    - ./run_playbook.bash site.yml
  environment:
    name: production/rahti
  when: manual
  only:
    - master
  tags:
    - rahti

scheduled_backups_oso_qa_job:
  stage: scheduled_backups
  variables:
    ENV_NAME: oso-qa
  script:
    - ./run_backup.bash
  only:
    - schedules
  tags:
    - oso-qa

scheduled_backups_rahti_int_job:
  stage: scheduled_backups
  variables:
    ENV_NAME: rahti-int
  script:
    - ./run_backup.bash
  only:
    - schedules
  tags:
    - rahti-int

scheduled_backups_rahti_job:
  stage: scheduled_backups
  variables:
    ENV_NAME: rahti
  script:
    - ./run_backup.bash
  only:
    - schedules
  tags:
    - rahti
