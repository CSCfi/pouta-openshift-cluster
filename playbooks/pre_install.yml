---
- name: Install NRPE for monitoring
  hosts: all
  become: yes
  roles:
    - ansible-role-nrpe
    - ansible-role-nrpe-plugins

- name: Configure bastion
  hosts: bastion
  become: yes
  roles:
    - base
    - cluster_common
    - bastion
    - ansible-role-mod_gearman

- name: Configure cluster common parts
  hosts:
    - masters
    - nodes
    - etcd
    - lb
    - nfsservers
  become: yes
  roles:
    - base
    - cluster_common

- name: Configure keepalived on LB nodes (multimaster installations)
  vars:
    - keepalived_state: "{{Â 'MASTER' if inventory_hostname.find('lb-1') != -1 else 'BACKUP' }}"
    - keepalived_priority: "{{ 90 if inventory_hostname.find('lb-1') != -1 else 60 }}"
    - poc_not_installed_weight: "-40"
    - keepalived_vip: "{{ lb_vip_ip }}"
    - keepalived_password: "{{ ( cluster_name | password_hash('sha256', common_salt )).split('$')[4]|truncate(8, True, '') }}"
  hosts:
    - lb
  roles:
    - keepalived

- name: Configure openshift VMs
  hosts:
    - masters
    - nodes
    - lb
    - etcd
  become: yes
  roles:
    - role: lvm_storage

    - role: docker_host
      docker_lvol_vg_name: "{{ 'vg_data' if docker_storage_driver == 'devicemapper' else '' }}"
      docker_lvol_size: "{{ '99%FREE' if docker_storage_driver == 'devicemapper' else '' }}"

- name: Configure openshift masters
  hosts:
    - masters
  become: yes
  roles:
    - openshift_master

- name: Configure openshift nodes
  hosts:
    - nodes
  become: yes
  roles:
    - openshift_node

- name: Prepare nfs server for OpenShift NFS playbook
  hosts:
    - nfsservers
  become: yes
  roles:
    - lvm_storage
    - nfs_server
