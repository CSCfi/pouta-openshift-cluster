---

- name: open port 53 for internal DNS
  lineinfile:
    line: "{{ item }}"
    dest: /etc/sysconfig/iptables
    insertbefore: '^-A INPUT'
  with_items:
    - "-A INPUT -p udp -m udp --dport 53 -j ACCEPT"
    - "-A INPUT -p tcp -m tcp --dport 53 -j ACCEPT"

- name: add a script for pruning old objects
  copy:
    src: files/poc_prune_objects.bash
    dest: /usr/local/bin/poc_prune_objects.bash
    mode: '0755'

- name: add a cron entry for object auto pruning
  cron:
    name: "Prune old OpenShift objects"
    hour: "{{ groups.masters.index(inventory_hostname) }}"
    minute: "42"
    cron_file: poc_openshift_pruning
    user: root
    job: "/usr/local/bin/poc_prune_objects.bash"

- block:
  - name: add a script for syncing ldap groups
    copy:
      src: files/poc_sync_ldap_groups.bash
      dest: /usr/local/bin/poc_sync_ldap_groups.bash
      mode: '0755'

  - set_fact:
       ldap_sync_cron_hours: |
         [{% for hour in range(groups.masters.index(inventory_hostname), 24, groups.masters|length )%}
         {{ hour }},
         {% endfor %}]

  - name: add a cron entry for syncing ldap groups
    cron:
      name: "Sync group information from LDAP"
      hour: "{{ ldap_sync_cron_hours|join(',') }}"
      minute: "{{ 59 |random(seed=cluster_name) }}"
      cron_file: poc_sync_ldap_groups
      user: root
      job: "/usr/local/bin/poc_sync_ldap_groups.bash --confirm"
  # endblock
  when:
    - deploy_ldap_group_sync | default(False) | bool
