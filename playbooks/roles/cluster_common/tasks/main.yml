---
- name: add entries to /etc/hosts for all cluster members
  lineinfile:
    state: present
    dest: /etc/hosts
    line: "{{ hostvars[item]['ansible_ssh_host'] }} {{ item }}.novalocal {{ item }}"
  when: hostvars[item]['ansible_ssh_host'] is defined
  with_items: "{{ groups['all'] }}"
  notify: reload dnsmasq

- name: add default iptables persistent state file
  template:
    src: etc/sysconfig/iptables.j2
    dest: /etc/sysconfig/iptables
    force: no

- name: generate ssh key for cloud-user
  user: name=cloud-user generate_ssh_key=yes ssh_key_type=rsa
  when: inventory_hostname in groups.bastion

- name: download public keys from bastion
  fetch: dest=/tmp/ansible/public_keys/ src=.ssh/id_rsa.pub
  when: inventory_hostname in groups.bastion

- name: authorize ssh with the downloaded key
  authorized_key: user=cloud-user key="{{ lookup('file', '/tmp/ansible/public_keys/{{ item }}/.ssh/id_rsa.pub') }}"
  with_items: "{{ groups.bastion }}"
  when: inventory_hostname not in groups.bastion

- name: set SELinux state
  selinux: state="{{ selinux_state }}"
  when: selinux_state is defined

# rpcbind is installed and enabled by default, turn it off for security
- name: disable rpcbind
  service: name=rpcbind state=stopped enabled=false

- name: allow connections to the NRPE daemons in the cluster
  lineinfile:
    dest: /etc/sysconfig/iptables
    insertafter: '^-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT'
    line: '-A INPUT -s 192.168.0.0/16 -d 192.168.0.0/16 -p tcp -m tcp --dport 5666 -j ACCEPT'
  notify: restart iptables
  when: inventory_hostname not in groups.bastion

- name: ensure /mnt is not mounted
  mount:
    path: '/mnt'
    state: unmounted

- name: ensure /mnt mount is not listed in fstab
  mount:
    path: '/mnt'
    state: absent
