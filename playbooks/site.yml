---
- name: Notify Flowdock on playbook start
  hosts: localhost
  gather_facts: no
  tasks:
    - flowdock:
        type: inbox
        source: Ansible
        token: "{{ flowdock_api_token }}"
        subject: "{{ cluster_display_name }}: Ansible playbook start"
        msg: "Started Ansible run in {{ cluster_display_name }}"
        from_address: "{{ team_email }}"
      when:
        - flowdock_api_token is defined
        - team_email is defined
      failed_when: false
      changed_when: false

- name: Fork public image to be used as base image for VMs if needed
  import_playbook: fork_public_image.yml

- name: Provision resources for OpenShift using Heat
  import_playbook: provision.yml

- name: Prepare hosts for OpenShift installation
  import_playbook: pre_install.yml

- import_playbook: get_install_state.yml

- name: Install a new OpenShift cluster
  import_playbook: install.yml
  when:
    - groups['new_masters']|default([])|length == groups['masters']|default([])|length

- name: Scale up an existing installation
  import_playbook: scaleup.yml
  when:
    - groups['new_masters']|default([])|length != groups['masters']|default([])|length

- import_playbook: set_install_state.yml

- name: Do post installation steps for OpenShift
  import_playbook: post_install.yml

# These need a working storage class in place, so install only after the
# post-install phase.
- name: Install service brokers
  import_playbook: "{{ os_ansible_path|default('../../openshift-ansible') }}/playbooks/openshift-service-catalog/config.yml"
  when:
    - ansible_service_broker_install or template_service_broker_install
    - groups['new_masters']|default([])|length == groups['masters']|default([])|length
