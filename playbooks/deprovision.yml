---
- hosts: localhost
  gather_facts: no
  connection: local
  roles:
    - poc_facts
  tasks:
    - name: make sure we are allowed to deprovision
      assert:
        that:
          - "{{ deprovision_allowed|default(False) }} == True"
        msg: "Must set deprovision_allowed to True to deprovision"

- name: Remove projects and persistent volumes still in use
  gather_facts: no
  hosts: masters[0]
  tasks:
    - name: Check if SSH works
      shell: ssh -o ConnectTimeout=10 {{ cluster_name }}-master-1 'echo success'
      register: ssh_result
      failed_when: false
      delegate_to: localhost

    # We remove PVCs and delete all pods to release the PVCs so that
    # Cinder driver can detach PVs from node hosts
    - name: remove PVCs from projects
      shell: |
        oc get namespace -o jsonpath='{.items[*].metadata.name}' | xargs -n 1 \
        oc delete {{ item }} --all -n --force --grace-period 0
      with_items:
      - pvc
      - pod
      failed_when: false
      when: ssh_result.stdout.find('success') == 0

    - name: wait for recycler pod to remove the dynamically provisioned PVs
      shell: oc get pv -o jsonpath='{.items[*].spec.cinder}'
      register: result
      until: result.stdout_lines|length == 0
      retries: 60
      delay: 5
      failed_when: false
      when: ssh_result.stdout.find('success') == 0

- hosts: localhost
  gather_facts: no
  connection: local
  roles:
    - poc_facts
  tasks:

    - name: Disassociate floating IP from bastion
      os_floating_ip:
        server: "{{ cluster_name }}-bastion"
        floating_ip_address: "{{ bastion_public_ip }}"
        state: absent
      failed_when: false

    - name: Disassociate floating IP from first LB node
      os_floating_ip:
        server: "{{ cluster_name }}-lb-1"
        floating_ip_address: "{{ openshift_public_ip }}"
        state: absent
      failed_when: false
      when: master_vm_group_size > 1

    - name: Disassociate floating IP from first master node
      os_floating_ip:
        server: "{{ cluster_name }}-master-1"
        floating_ip_address: "{{ openshift_public_ip }}"
        state: absent
      failed_when: false
      when: master_vm_group_size == 1

    - name: Delete public key
      os_keypair:
        state: absent
        name: "{{ cluster_name }}"

    - name: Delete compute nodes stacks
      os_stack:
        name: "{{ cluster_name }}-{{ item.stack_name }}"
        state: absent
        wait: yes
      with_items: "{{ compute_node_groups }}"

    - name: Delete stack {{ cluster_name }}-etcd (multimaster)
      os_stack:
        name: "{{ cluster_name }}-etcd"
        state: absent
        wait: yes

    - name: Delete stack {{ cluster_name }}-cluster
      os_stack:
        name: "{{ cluster_name }}-cluster"
        state: absent
        wait: yes

    - name: Delete stack {{ cluster_name }}-glusterfs
      os_stack:
        name: "{{ cluster_name }}-glusterfs"
        state: absent
        wait: yes

    - name: Delete stack {{ cluster_name }}-base
      os_stack:
        name: "{{ cluster_name }}-base"
        state: absent
        wait: yes

    - name: Remove inventory cache
      file:
        path: "{{ lookup('env', 'HOME') }}/.cache/openstack/ansible-inventory.cache"
        state: absent
